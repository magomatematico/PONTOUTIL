<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema de Gestão Empresarial</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; background-color: #f4f4f4; }
        h1 { text-align: center; color: #333; }
        h2 { color: #444; margin-top: 20px; }
        .tab { 
            border: 1px solid #ccc; 
            padding: 20px; 
            margin-bottom: 20px; 
            background-color: #fff; 
            border-radius: 8px; 
            box-shadow: 0 2px 5px rgba(0,0,0,0.1); 
        }
        table { 
            width: 100%; 
            border-collapse: collapse; 
            margin-top: 10px; 
        }
        th, td { 
            border: 1px solid #ddd; 
            padding: 8px; 
            text-align: left; 
        }
        th { 
            background-color: #f2f2f2; 
            color: #333; 
        }
        button { 
            padding: 8px 12px; 
            margin: 5px; 
            border: none; 
            border-radius: 4px; 
            cursor: pointer; 
            background-color: #28a745; 
            color: white; 
        }
        button.delete { 
            background-color: #dc3545; 
        }
        input, select { 
            padding: 6px; 
            margin: 5px; 
            border: 1px solid #ccc; 
            border-radius: 4px; 
        }
        .form-container { 
            margin-bottom: 20px; 
            background-color: #f9f9f9; 
            padding: 15px; 
            border-radius: 8px; 
        }
        .tab-nav { 
            display: flex; 
            gap: 10px; 
            margin-bottom: 20px; 
        }
        .tab-nav button { 
            background-color: #007bff; 
        }
        .tab-nav button.active { 
            background-color: #0056b3; 
        }
        .hidden { 
            display: none; 
        }
        .summary { 
            margin-top: 20px; 
            padding: 15px; 
            background-color: #e9ecef; 
            border-radius: 8px; 
        }
    </style>
</head>
<body>
    <h1>Sistema de Gestão Empresarial</h1>
    <div class="tab-nav">
        <button onclick="showTab('estoque')" class="active">Estoque</button>
        <button onclick="showTab('vendas')">Vendas</button>
        <button onclick="showTab('fornecedores')">Fornecedores</button>
        <button onclick="showTab('financeiro')">Financeiro</button>
        <button onclick="showTab('geral')">Geral</button>
    </div>

    <!-- Estoque -->
    <div id="estoque" class="tab">
        <h2>Gestão de Estoque</h2>
        <div class="form-container">
            <input type="text" id="produtoCodigo" placeholder="Código do Produto" required>
            <input type="text" id="produtoNome" placeholder="Nome do Produto" required>
            <input type="number" id="produtoQuantidade" placeholder="Quantidade Inicial" min="0" required>
            <input type="number" id="produtoPrecoCompra" placeholder="Preço de Compra (R$)" min="0" step="0.01" required>
            <input type="number" id="produtoPrecoVenda" placeholder="Preço de Venda (R$)" min="0" step="0.01" required>
            <button onclick="adicionarProduto()">Adicionar Produto</button>
        </div>
        <table id="tabelaEstoque">
            <thead>
                <tr>
                    <th>Código</th>
                    <th>Nome</th>
                    <th>Quantidade Inicial</th>
                    <th>Entradas</th>
                    <th>Saídas</th>
                    <th>Saldo Atual</th>
                    <th>Preço Compra</th>
                    <th>Preço Venda</th>
                    <th>Ações</th>
                </tr>
            </thead>
            <tbody></tbody>
        </table>
    </div>

    <!-- Vendas -->
    <div id="vendas" class="tab hidden">
        <h2>Registro de Vendas</h2>
        <div class="form-container">
            <input type="date" id="vendaData" required>
            <select id="vendaProduto" required>
                <option value="">Selecione o Produto</option>
            </select>
            <input type="number" id="vendaQuantidade" placeholder="Quantidade" min="1" required>
            <input type="text" id="vendaCliente" placeholder="Nome do Cliente" required>
            <button onclick="adicionarVenda()">Registrar Venda</button>
        </div>
        <table id="tabelaVendas">
            <thead>
                <tr>
                    <th>Data</th>
                    <th>Produto</th>
                    <th>Código</th>
                    <th>Quantidade</th>
                    <th>Preço Venda</th>
                    <th>Cliente</th>
                    <th>Ações</th>
                </tr>
            </thead>
            <tbody></tbody>
        </table>
    </div>

    <!-- Fornecedores -->
    <div id="fornecedores" class="tab hidden">
        <h2>Gestão de Fornecedores</h2>
        <div class="form-container">
            <input type="text" id="fornecedorNome" placeholder="Nome do Fornecedor" required>
            <input type="date" id="fornecedorDataCompra" required>
            <input type="number" id="fornecedorValor" placeholder="Valor do Pedido (R$)" min="0" step="0.01" required>
            <input type="text" id="fornecedorContato" placeholder="Contato" required>
            <button onclick="adicionarFornecedor()">Adicionar Fornecedor</button>
        </div>
        <table id="tabelaFornecedores">
            <thead>
                <tr>
                    <th>Fornecedor</th>
                    <th>Data Compra</th>
                    <th>Valor Pedido</th>
                    <th>Contato</th>
                    <th>Ações</th>
                </tr>
            </thead>
            <tbody></tbody>
        </table>
    </div>

    <!-- Financeiro -->
    <div id="financeiro" class="tab hidden">
        <h2>Financeiro</h2>
        <table id="tabelaFinanceiro">
            <thead>
                <tr>
                    <th>Descrição</th>
                    <th>Valor</th>
                </tr>
            </thead>
            <tbody>
                <tr><td>Valor Total em Mercadoria (Custo)</td><td id="valorMercadoria">R$ 0,00</td></tr>
                <tr><td>Valor Total de Vendas</td><td id="valorVendas">R$ 0,00</td></tr>
                <tr><td>Valor Total de Saídas (Custo)</td><td id="valorSaidas">R$ 0,00</td></tr>
                <tr><td>Saldo (Lucro)</td><td id="saldoFinanceiro">R$ 0,00</td></tr>
            </tbody>
        </table>
    </div>

    <!-- Geral -->
    <div id="geral" class="tab hidden">
        <h2>Controle Geral</h2>
        <div class="form-container">
            <h3>Definir Capital Inicial</h3>
            <input type="number" id="geralCapitalInicial" placeholder="Capital Inicial (R$)" min="0" step="0.01">
            <button onclick="definirCapitalGeral()">Definir Capital</button>
        </div>
        <div class="form-container">
            <h3>Registrar Saída (Compra de Mercadoria)</h3>
            <input type="date" id="geralDataMovimentacao" required>
            <input type="number" id="geralValorMovimentacao" placeholder="Valor (R$)" min="0" step="0.01" required>
            <input type="text" id="geralDescricaoMovimentacao" placeholder="Descrição (ex: Compra de Mercadoria)" required>
            <button onclick="adicionarMovimentacaoGeral()">Adicionar Saída</button>
        </div>
        <table id="tabelaGeral">
            <thead>
                <tr>
                    <th>Data</th>
                    <th>Tipo</th>
                    <th>Valor</th>
                    <th>Descrição</th>
                    <th>Ações</th>
                </tr>
            </thead>
            <tbody></tbody>
        </table>
        <div class="summary">
            <h3>Resumo Geral</h3>
            <table>
                <tr><td>Capital Inicial</td><td id="geralResumoCapitalInicial">R$ 0,00</td></tr>
                <tr><td>Total de Entradas (Lucro)</td><td id="geralResumoEntradas">R$ 0,00</td></tr>
                <tr><td>Total de Saídas (Compras)</td><td id="geralResumoSaidas">R$ 0,00</td></tr>
                <tr><td>Saldo Atual (Capital + Lucro - Saídas)</td><td id="geralResumoSaldo">R$ 0,00</td></tr>
            </table>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, collection, addDoc, getDocs, deleteDoc, doc, updateDoc, getDoc, setDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        // Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyBkh-Is_r0BwuQcnEW1lzIAxS49q3ZkJIc",
            authDomain: "ponto-util-51954.firebaseapp.com",
            projectId: "ponto-util-51954",
            storageBucket: "ponto-util-51954.firebasestorage.app",
            messagingSenderId: "349199654027",
            appId: "1:349199654027:web:4defbd961856b2e9d6488e",
            measurementId: "G-T3JVXWSBJN"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        // Configuração do formatador para Real (R$)
        const formatter = new Intl.NumberFormat('pt-BR', {
            style: 'currency',
            currency: 'BRL',
            minimumFractionDigits: 2
        });

        // Inicialização
        async function init() {
            await atualizarTabelaEstoque();
            await atualizarTabelaVendas();
            await atualizarTabelaFornecedores();
            await atualizarTabelaGeral();
            await atualizarSelectProdutos();
            await atualizarFinanceiro();
            await atualizarResumoGeral();
        }
        init();

        // Funções de Estoque
        async function adicionarProduto() {
            const codigo = document.getElementById('produtoCodigo').value;
            const nome = document.getElementById('produtoNome').value;
            const quantidade = parseInt(document.getElementById('produtoQuantidade').value);
            const precoCompra = parseFloat(document.getElementById('produtoPrecoCompra').value);
            const precoVenda = parseFloat(document.getElementById('produtoPrecoVenda').value);

            if (!codigo || !nome || isNaN(quantidade) || isNaN(precoCompra) || isNaN(precoVenda)) {
                alert('Preencha todos os campos corretamente.');
                return;
            }

            // Verificar se código existe
            const q = collection(db, 'estoque');
            const snapshot = await getDocs(q);
            const exists = snapshot.docs.some(d => d.data().codigo === codigo);
            if (exists) {
                alert('Código de produto já existe.');
                return;
            }

            await addDoc(collection(db, 'estoque'), {
                codigo,
                nome,
                quantidadeInicial: quantidade,
                entradas: 0,
                saidas: 0,
                saldoAtual: quantidade,
                precoCompra,
                precoVenda
            });

            await atualizarTabelaEstoque();
            await atualizarSelectProdutos();
            limparFormulario('produto');
        }

        async function atualizarTabelaEstoque() {
            const tbody = document.querySelector('#tabelaEstoque tbody');
            tbody.innerHTML = '';
            const querySnapshot = await getDocs(collection(db, 'estoque'));
            querySnapshot.forEach((d) => {
                const produto = d.data();
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td>${produto.codigo}</td>
                    <td>${produto.nome}</td>
                    <td>${produto.quantidadeInicial}</td>
                    <td>${produto.entradas}</td>
                    <td>${produto.saidas}</td>
                    <td>${produto.saldoAtual}</td>
                    <td>${formatter.format(produto.precoCompra)}</td>
                    <td>${formatter.format(produto.precoVenda)}</td>
                    <td><button class="delete" onclick="removerProduto('${d.id}')">Excluir</button></td>
                `;
                tbody.appendChild(tr);
            });
            await atualizarFinanceiro();
        }

        async function removerProduto(id) {
            if (confirm('Deseja excluir este produto?')) {
                await deleteDoc(doc(db, 'estoque', id));
                await atualizarTabelaEstoque();
                await atualizarSelectProdutos();
            }
        }

        // Funções de Vendas
        async function atualizarSelectProdutos() {
            const select = document.getElementById('vendaProduto');
            select.innerHTML = '<option value="">Selecione o Produto</option>';
            const querySnapshot = await getDocs(collection(db, 'estoque'));
            querySnapshot.forEach((d) => {
                const produto = d.data();
                const option = document.createElement('option');
                option.value = produto.codigo;
                option.textContent = `${produto.codigo} - ${produto.nome}`;
                select.appendChild(option);
            });
        }

        async function adicionarVenda() {
            const data = document.getElementById('vendaData').value;
            const codigo = document.getElementById('vendaProduto').value;
            const quantidade = parseInt(document.getElementById('vendaQuantidade').value);
            const cliente = document.getElementById('vendaCliente').value;

            if (!data || !codigo || isNaN(quantidade) || !cliente) {
                alert('Preencha todos os campos corretamente.');
                return;
            }

            // Encontrar produto
            const estoqueSnap = await getDocs(collection(db, 'estoque'));
            let produtoDoc = null;
            let produto = null;
            estoqueSnap.forEach((d) => {
                if (d.data().codigo === codigo) {
                    produtoDoc = d;
                    produto = d.data();
                }
            });

            if (!produto) {
                alert('Produto não encontrado.');
                return;
            }

            if (produto.saldoAtual < quantidade) {
                alert('Quantidade em estoque insuficiente.');
                return;
            }

            // Atualizar estoque
            const newSaidas = produto.saidas + quantidade;
            const newSaldo = produto.quantidadeInicial + produto.entradas - newSaidas;
            await updateDoc(doc(db, 'estoque', produtoDoc.id), {
                saidas: newSaidas,
                saldoAtual: newSaldo
            });

            // Adicionar venda
            await addDoc(collection(db, 'vendas'), {
                data,
                codigo,
                nome: produto.nome,
                quantidade,
                precoVenda: produto.precoVenda,
                cliente
            });

            await atualizarTabelaEstoque();
            await atualizarTabelaVendas();
            await atualizarResumoGeral();
            limparFormulario('venda');
        }

        async function atualizarTabelaVendas() {
            const tbody = document.querySelector('#tabelaVendas tbody');
            tbody.innerHTML = '';
            const querySnapshot = await getDocs(collection(db, 'vendas'));
            querySnapshot.forEach((d) => {
                const venda = d.data();
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td>${venda.data}</td>
                    <td>${venda.nome}</td>
                    <td>${venda.codigo}</td>
                    <td>${venda.quantidade}</td>
                    <td>${formatter.format(venda.precoVenda)}</td>
                    <td>${venda.cliente}</td>
                    <td><button class="delete" onclick="removerVenda('${d.id}')">Excluir</button></td>
                `;
                tbody.appendChild(tr);
            });
            await atualizarFinanceiro();
        }

        async function removerVenda(id) {
            if (confirm('Deseja excluir esta venda?')) {
                const vendaDoc = await getDoc(doc(db, 'vendas', id));
                const venda = vendaDoc.data();

                // Encontrar produto
                const estoqueSnap = await getDocs(collection(db, 'estoque'));
                let produtoDoc = null;
                let produto = null;
                estoqueSnap.forEach((d) => {
                    if (d.data().codigo === venda.codigo) {
                        produtoDoc = d;
                        produto = d.data();
                    }
                });

                if (produto) {
                    const newSaidas = produto.saidas - venda.quantidade;
                    const newSaldo = produto.quantidadeInicial + produto.entradas - newSaidas;
                    await updateDoc(doc(db, 'estoque', produtoDoc.id), {
                        saidas: newSaidas,
                        saldoAtual: newSaldo
                    });
                }

                await deleteDoc(doc(db, 'vendas', id));
                await atualizarTabelaEstoque();
                await atualizarTabelaVendas();
                await atualizarResumoGeral();
            }
        }

        // Funções de Fornecedores
        async function adicionarFornecedor() {
            const nome = document.getElementById('fornecedorNome').value;
            const dataCompra = document.getElementById('fornecedorDataCompra').value;
            const valor = parseFloat(document.getElementById('fornecedorValor').value);
            const contato = document.getElementById('fornecedorContato').value;

            if (!nome || !dataCompra || isNaN(valor) || !contato) {
                alert('Preencha todos os campos corretamente.');
                return;
            }

            await addDoc(collection(db, 'fornecedores'), { nome, dataCompra, valor, contato });
            await atualizarTabelaFornecedores();
            limparFormulario('fornecedor');
        }

        async function atualizarTabelaFornecedores() {
            const tbody = document.querySelector('#tabelaFornecedores tbody');
            tbody.innerHTML = '';
            const querySnapshot = await getDocs(collection(db, 'fornecedores'));
            querySnapshot.forEach((d) => {
                const fornecedor = d.data();
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td>${fornecedor.nome}</td>
                    <td>${fornecedor.dataCompra}</td>
                    <td>${formatter.format(fornecedor.valor)}</td>
                    <td>${fornecedor.contato}</td>
                    <td><button class="delete" onclick="removerFornecedor('${d.id}')">Excluir</button></td>
                `;
                tbody.appendChild(tr);
            });
        }

        async function removerFornecedor(id) {
            if (confirm('Deseja excluir este fornecedor?')) {
                await deleteDoc(doc(db, 'fornecedores', id));
                await atualizarTabelaFornecedores();
            }
        }

        // Funções Financeiro
        async function atualizarFinanceiro() {
            const estoqueSnap = await getDocs(collection(db, 'estoque'));
            const vendasSnap = await getDocs(collection(db, 'vendas'));

            const estoqueData = estoqueSnap.docs.map(d => d.data());
            const vendasData = vendasSnap.docs.map(d => d.data());

            const valorMercadoria = estoqueData.reduce((sum, p) => sum + (p.saldoAtual * p.precoCompra), 0);
            const valorVendas = vendasData.reduce((sum, v) => sum + (v.quantidade * v.precoVenda), 0);
            const valorSaidas = vendasData.reduce((sum, v) => {
                const produto = estoqueData.find(p => p.codigo === v.codigo);
                return sum + (v.quantidade * (produto ? produto.precoCompra : 0));
            }, 0);
            const saldo = valorVendas - valorSaidas;

            document.getElementById('valorMercadoria').textContent = formatter.format(valorMercadoria);
            document.getElementById('valorVendas').textContent = formatter.format(valorVendas);
            document.getElementById('valorSaidas').textContent = formatter.format(valorSaidas);
            document.getElementById('saldoFinanceiro').textContent = formatter.format(saldo);

            await atualizarResumoGeral();
        }

        // Funções Geral
        async function definirCapitalGeral() {
            const capital = parseFloat(document.getElementById('geralCapitalInicial').value);
            if (isNaN(capital) || capital < 0) {
                alert('Insira um valor válido para o capital inicial.');
                return;
            }
            await setDoc(doc(db, 'config', 'capital'), { valor: capital });
            await atualizarResumoGeral();
            document.getElementById('geralCapitalInicial').value = '';
        }

        async function adicionarMovimentacaoGeral() {
            const data = document.getElementById('geralDataMovimentacao').value;
            const valor = parseFloat(document.getElementById('geralValorMovimentacao').value);
            const descricao = document.getElementById('geralDescricaoMovimentacao').value;

            if (!data || isNaN(valor) || valor <= 0 || !descricao) {
                alert('Preencha todos os campos corretamente.');
                return;
            }

            await addDoc(collection(db, 'geralMovimentacoes'), { tipo: 'saida', data, valor, descricao });
            await atualizarTabelaGeral();
            limparFormulario('geral');
        }

        async function atualizarTabelaGeral() {
            const tbody = document.querySelector('#tabelaGeral tbody');
            tbody.innerHTML = '';
            const querySnapshot = await getDocs(collection(db, 'geralMovimentacoes'));
            querySnapshot.forEach((d) => {
                const mov = d.data();
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td>${mov.data}</td>
                    <td>Saída (Compra)</td>
                    <td>${formatter.format(mov.valor)}</td>
                    <td>${mov.descricao}</td>
                    <td><button class="delete" onclick="removerMovimentacaoGeral('${d.id}')">Excluir</button></td>
                `;
                tbody.appendChild(tr);
            });
            await atualizarResumoGeral();
        }

        async function removerMovimentacaoGeral(id) {
            if (confirm('Deseja excluir esta movimentação?')) {
                await deleteDoc(doc(db, 'geralMovimentacoes', id));
                await atualizarTabelaGeral();
            }
        }

        async function atualizarResumoGeral() {
            const estoqueSnap = await getDocs(collection(db, 'estoque'));
            const vendasSnap = await getDocs(collection(db, 'vendas'));
            const movimentacoesSnap = await getDocs(collection(db, 'geralMovimentacoes'));
            const capitalDoc = await getDoc(doc(db, 'config', 'capital'));

            const estoqueData = estoqueSnap.docs.map(d => d.data());
            const vendasData = vendasSnap.docs.map(d => d.data());
            const movimentacoesData = movimentacoesSnap.docs.map(d => d.data());

            const geralCapitalInicial = capitalDoc.exists() ? capitalDoc.data().valor : 0;

            const valorVendas = vendasData.reduce((sum, v) => sum + (v.quantidade * v.precoVenda), 0);
            const valorSaidas = vendasData.reduce((sum, v) => {
                const produto = estoqueData.find(p => p.codigo === v.codigo);
                return sum + (v.quantidade * (produto ? produto.precoCompra : 0));
            }, 0);
            const totalEntradas = valorVendas - valorSaidas;
            const totalSaidas = movimentacoesData
                .filter(m => m.tipo === 'saida')
                .reduce((sum, m) => sum + m.valor, 0);
            const saldo = geralCapitalInicial + totalEntradas - totalSaidas;

            document.getElementById('geralResumoCapitalInicial').textContent = formatter.format(geralCapitalInicial);
            document.getElementById('geralResumoEntradas').textContent = formatter.format(totalEntradas);
            document.getElementById('geralResumoSaidas').textContent = formatter.format(totalSaidas);
            document.getElementById('geralResumoSaldo').textContent = formatter.format(saldo);
        }

        // Funções Auxiliares
        function limparFormulario(tipo) {
            if (tipo === 'produto') {
                document.getElementById('produtoCodigo').value = '';
                document.getElementById('produtoNome').value = '';
                document.getElementById('produtoQuantidade').value = '';
                document.getElementById('produtoPrecoCompra').value = '';
                document.getElementById('produtoPrecoVenda').value = '';
            } else if (tipo === 'venda') {
                document.getElementById('vendaData').value = '';
                document.getElementById('vendaProduto').value = '';
                document.getElementById('vendaQuantidade').value = '';
                document.getElementById('vendaCliente').value = '';
            } else if (tipo === 'fornecedor') {
                document.getElementById('fornecedorNome').value = '';
                document.getElementById('fornecedorDataCompra').value = '';
                document.getElementById('fornecedorValor').value = '';
                document.getElementById('fornecedorContato').value = '';
            } else if (tipo === 'geral') {
                document.getElementById('geralDataMovimentacao').value = '';
                document.getElementById('geralValorMovimentacao').value = '';
                document.getElementById('geralDescricaoMovimentacao').value = '';
            }
        }

        function showTab(tabId) {
            document.querySelectorAll('.tab').forEach(tab => tab.classList.add('hidden'));
            document.getElementById(tabId).classList.remove('hidden');
            document.querySelectorAll('.tab-nav button').forEach(btn => btn.classList.remove('active'));
            document.querySelector(`.tab-nav button[onclick="showTab('${tabId}')"]`).classList.add('active');
        }
    </script>
</body>
</html>
